import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import speech_recognition as sr
import threading
import pyperclip
import time
import pyautogui
import keyboard  # –î–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à

class SmartVoiceNotepad:
    def __init__(self, root):
        self.root = root
        self.root.title("üé§ –£–ú–ù–´–ô –ì–û–õ–û–°–û–í–û–ô –ë–õ–û–ö–ù–û–¢")
        self.root.geometry("900x650")
        self.root.configure(bg='#f0f0f0')
        
        self.recognizer = sr.Recognizer()
        self.listening = False
        self.current_text = ""
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ì–õ–û–ë–ê–õ–¨–ù–£–Æ –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É F12
        try:
            keyboard.add_hotkey('f12', self.paste_text_global)
            print("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏—à–∞ F12 –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ F12: {e}")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—è
        self.recognizer.energy_threshold = 300
        self.recognizer.dynamic_energy_threshold = True
        self.recognizer.pause_threshold = 1.2
        
        # –°—Ç–∏–ª—å
        style = ttk.Style()
        style.configure('TButton', font=('Arial', 10), padding=6)
        style.configure('Title.TLabel', font=('Arial', 16, 'bold'), background='#f0f0f0')
        style.configure('Paste.TButton', background='#9b59b6', foreground='white')
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = ttk.Label(root, text="üé§ –£–ú–ù–´–ô –ì–û–õ–û–°–û–í–û–ô –ë–õ–û–ö–ù–û–¢", style='Title.TLabel')
        title_label.pack(pady=10)
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫
        button_frame = ttk.Frame(root)
        button_frame.pack(pady=10)
        
        # –ö–Ω–æ–ø–∫–∏
        self.start_btn = ttk.Button(button_frame, text="üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å", command=self.toggle_recording)
        self.start_btn.pack(side=tk.LEFT, padx=5)
        
        self.clear_btn = ttk.Button(button_frame, text="üßπ –û—á–∏—Å—Ç–∏—Ç—å", command=self.clear_text)
        self.clear_btn.pack(side=tk.LEFT, padx=5)
        
        self.copy_btn = ttk.Button(button_frame, text="üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", command=self.copy_to_clipboard)
        self.copy_btn.pack(side=tk.LEFT, padx=5)
        
        self.fix_btn = ttk.Button(button_frame, text="‚ú® –ò—Å–ø—Ä–∞–≤–∏—Ç—å", command=self.auto_correct)
        self.fix_btn.pack(side=tk.LEFT, padx=5)
        
        self.paste_btn = ttk.Button(button_frame, text="üì§ –í—Å—Ç–∞–≤–∏—Ç—å (F12)", command=self.paste_text, style='Paste.TButton')
        self.paste_btn.pack(side=tk.LEFT, padx=5)
        
        # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
        self.record_indicator = ttk.Label(root, text="üî¥ –ù–ï –ó–ê–ü–ò–°–´–í–ê–ï–¢", font=('Arial', 12, 'bold'), foreground='red')
        self.record_indicator.pack(pady=5)
        
        # –ú–µ—Ç–∫–∞ –¥–ª—è –≥–æ—Ä—è—á–µ–π –∫–ª–∞–≤–∏—à–∏
        hotkey_label = ttk.Label(root, text="üî• –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –∫–ª–∞–≤–∏—à–∞: F12 - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!", 
                               font=('Arial', 10, 'bold'), foreground='#e74c3c')
        hotkey_label.pack(pady=2)
        
        # –ú–µ—Ç–∫–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        text_label = ttk.Label(root, text="–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:", font=('Arial', 10, 'bold'))
        text_label.pack(pady=(10, 5))
        
        # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        self.text_area = scrolledtext.ScrolledText(root, wrap=tk.WORD, width=100, height=18, 
                                                  font=('Arial', 11), bg='white', relief=tk.SUNKEN, bd=2)
        self.text_area.pack(pady=5, padx=10, fill=tk.BOTH, expand=True)
        self.text_area.insert(tk.END, "–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç...\n\n")
        
        # –°—Ç–∞—Ç—É—Å –±–∞—Ä
        self.status_var = tk.StringVar()
        self.status_var.set("‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ù–∞–∂–º–∏—Ç–µ '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å'")
        status_bar = ttk.Label(root, textvariable=self.status_var, relief=tk.SUNKEN, anchor=tk.W)
        status_bar.pack(side=tk.BOTTOM, fill=tk.X)
        
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
        instruction_text = """üí° –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
1. –ù–∞–∂–º–∏—Ç–µ '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å' - –≥–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
2. –¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è
3. –ü–ï–†–ï–ö–õ–Æ–ß–ò–¢–ï–°–¨ –≤ –Ω—É–∂–Ω–æ–µ –æ–∫–Ω–æ (–±—Ä–∞—É–∑–µ—Ä, Word, —á–∞—Ç)
4. –ù–∞–∂–º–∏—Ç–µ F12 - —Ç–µ–∫—Å—Ç –≤—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
5. F12 —Ä–∞–±–æ—Ç–∞–µ—Ç –í–ï–ó–î–ï - –¥–∞–∂–µ –∫–æ–≥–¥–∞ –æ–∫–Ω–æ —Å–≤—ë—Ä–Ω—É—Ç–æ!"""

        instruction = ttk.Label(root, text=instruction_text, font=('Arial', 9), 
                               background='#e8f4f8', wraplength=850, justify=tk.LEFT)
        instruction.pack(pady=10, padx=10)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
        try:
            self.microphone = sr.Microphone(device_index=0)
            mic_list = sr.Microphone.list_microphone_names()
            if mic_list:
                self.status_var.set(f"‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω: {mic_list[0]}")
            else:
                self.microphone = None
                self.start_btn.config(state='disabled')
                self.status_var.set("‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        except Exception as e:
            self.microphone = None
            self.start_btn.config(state='disabled')
            self.status_var.set(f"‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: {str(e)}")
    
    def paste_text_global(self):
        """–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è F12 - —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        if hasattr(self, 'current_text') and self.current_text.strip():
            try:
                # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä
                pyperclip.copy(self.current_text.strip())
                
                # –ù–µ–º–Ω–æ–≥–æ –∂–¥–µ–º —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω
                time.sleep(0.1)
                
                # –í—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Ctrl+V
                pyautogui.hotkey('ctrl', 'v')
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Å—Ç–∞—Ç—É—Å–µ (–µ—Å–ª–∏ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ)
                if self.root.winfo_exists():
                    self.status_var.set("‚úÖ –¢–µ–∫—Å—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ F12!")
                
            except Exception as e:
                if self.root.winfo_exists():
                    self.status_var.set(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    
    def paste_text(self):
        """–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"""
        self.paste_text_global()
    
    def add_punctuation(self, text):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è"""
        text = text.lower().strip()
        
        punctuation_commands = {
            '—Ç–æ—á–∫–∞': '.', '—Ç–æ—á–∫—É': '.', '—Ç–æ—á–∫–∏': '.',
            '–∑–∞–ø—è—Ç–∞—è': ',', '–∑–∞–ø—è—Ç—É—é': ',', '–∑–∞–ø—è—Ç—ã–µ': ',',
            '–≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫': '!', '–≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫': '?',
            '–¥–≤–æ–µ—Ç–æ—á–∏–µ': ':', '—Ç–∏—Ä–µ': ' - ', '–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞': '\n',
            '–∫–∞–≤—ã—á–∫–∏': '"', '—Å–∫–æ–±–∫–∏': '()', '—Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π': ';'
        }
        
        for command, symbol in punctuation_commands.items():
            if command in text:
                return symbol
        
        question_words = {'–∫—Ç–æ', '—á—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É', '–∫–∞–∫', '—Å–∫–æ–ª—å–∫–æ', '—á–µ–π', '–∫–∞–∫–æ–π'}
        words = text.split()
        
        if len(words) > 0:
            if any(word in question_words for word in words[:2]):
                return '?'
            
            if any(word in {'–æ–≥–æ', '—É—Ö', '–∞—Ö', '–≤–∞—É', '–∑–¥–æ—Ä–æ–≤–æ'} for word in words):
                return '!'
            
            if len(words) > 6 and text[-1] not in {'.', '!', '?'}:
                return ','
        
        return ''
    
    def auto_correct_text(self, text):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
        corrections = {
            '—Å–∫–æ–ø–∏—Ä–æ–∞–Ω–æ–æ': '—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
            '–ø—Ä–∏–≤–µ—Ç': '–ø—Ä–∏–≤–µ—Ç',
            '–∫–∞–∫–¥–µ–ª–∞': '–∫–∞–∫ –¥–µ–ª–∞',
            '—Å–ø–∞—Å–∏–±–æ': '—Å–ø–∞—Å–∏–±–æ',
            '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞': '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
            '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ': '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ',
            '–∏–∑–≤–∏–Ω–∏—Ç–µ': '–∏–∑–≤–∏–Ω–∏—Ç–µ',
            '—Ö–æ—Ä–æ—à–æ': '—Ö–æ—Ä–æ—à–æ',
            '–ø–ª–æ—Ö–æ': '–ø–ª–æ—Ö–æ',
            '–Ω–æ—Ä–º–∞–ª—å–Ω–æ': '–Ω–æ—Ä–º–∞–ª—å–Ω–æ'
        }
        
        for wrong, correct in corrections.items():
            text = text.replace(wrong, correct)
        
        return text
    
    def process_text(self, text):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞"""
        text = text.lower().strip()
        text = self.auto_correct_text(text)
        punctuation = self.add_punctuation(text)
        
        for command in {'—Ç–æ—á–∫–∞', '–∑–∞–ø—è—Ç–∞—è', '–≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π', '–≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π', 
                       '–¥–≤–æ–µ—Ç–æ—á–∏–µ', '—Ç–∏—Ä–µ', '–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞', '–∫–∞–≤—ã—á–∫–∏', '—Å–∫–æ–±–∫–∏'}:
            text = text.replace(command, '')
        
        text = text.strip()
        
        if punctuation:
            if punctuation in {'.', '!', '?', ';', ':'}:
                return text + punctuation + ' '
            elif punctuation == ',':
                return text + punctuation + ' '
            else:
                return punctuation + text + ' '
        else:
            return text + ' '
    
    def toggle_recording(self):
        if not self.listening:
            self.start_listening()
        else:
            self.stop_listening()
    
    def start_listening(self):
        if self.microphone is None:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω!")
            return
            
        self.listening = True
        self.start_btn.config(text="‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")
        self.record_indicator.config(text="üü¢ –ó–ê–ü–ò–°–¨ –ò–î–Å–¢... –ì–û–í–û–†–ò–¢–ï", foreground='green')
        self.status_var.set("üé§ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞... –ì–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ!")
        
        self.thread = threading.Thread(target=self.continuous_listen)
        self.thread.daemon = True
        self.thread.start()
    
    def stop_listening(self):
        self.listening = False
        self.start_btn.config(text="üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å")
        self.record_indicator.config(text="üî¥ –ù–ï –ó–ê–ü–ò–°–´–í–ê–ï–¢", foreground='red')
        self.status_var.set("‚è∏Ô∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    
    def continuous_listen(self):
        with self.microphone as source:
            self.recognizer.adjust_for_ambient_noise(source, duration=1)
            
            while self.listening:
                try:
                    audio = self.recognizer.listen(source, timeout=None, phrase_time_limit=8)
                    text = self.recognizer.recognize_google(audio, language="ru-RU")
                    
                    processed_text = self.process_text(text)
                    
                    self.root.after(0, self.update_text, processed_text)
                    self.root.after(0, lambda: self.status_var.set(f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {text}"))
                    
                except sr.WaitTimeoutError:
                    continue
                except sr.UnknownValueError:
                    self.root.after(0, lambda: self.status_var.set("‚ùå –†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞"))
                    continue
                except Exception as e:
                    self.root.after(0, lambda: self.status_var.set(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}"))
                    time.sleep(1)
    
    def update_text(self, text):
        self.current_text += text
        self.text_area.delete(1.0, tk.END)
        self.text_area.insert(tk.END, self.current_text.capitalize())
        self.copy_to_clipboard()
        self.text_area.see(tk.END)
    
    def auto_correct(self):
        if self.current_text:
            if self.current_text and self.current_text[0].islower():
                self.current_text = self.current_text[0].upper() + self.current_text[1:]
            
            if self.current_text.strip() and self.current_text[-1] not in {'.', '!', '?', ',', ';', ':'}:
                self.current_text = self.current_text.strip() + '.'
            
            self.text_area.delete(1.0, tk.END)
            self.text_area.insert(tk.END, self.current_text)
            self.copy_to_clipboard()
            self.status_var.set("‚ú® –¢–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!")
    
    def clear_text(self):
        self.current_text = ""
        self.text_area.delete(1.0, tk.END)
        pyperclip.copy("")
        self.status_var.set("üßπ –¢–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω")
    
    def copy_to_clipboard(self):
        if self.current_text.strip():
            pyperclip.copy(self.current_text.strip())
            self.status_var.set("üìã –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!")
    
    def on_closing(self):
        self.listening = False
        # –£–±–∏—Ä–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É
        try:
            keyboard.remove_hotkey('f12')
        except:
            pass
        time.sleep(0.5)
        self.root.destroy()

if __name__ == "__main__":
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏
    try:
        import pyautogui
    except ImportError:
        print("–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pyautogui...")
        import subprocess
        subprocess.check_call(["pip", "install", "pyautogui"])
        import pyautogui
    
    try:
        import keyboard
    except ImportError:
        print("–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º keyboard...")
        import subprocess
        subprocess.check_call(["pip", "install", "keyboard"])
        import keyboard
    
    root = tk.Tk()
    app = SmartVoiceNotepad(root)
    root.protocol("WM_DELETE_WINDOW", app.on_closing)
    root.mainloop()
